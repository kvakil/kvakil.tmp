<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Remote builds with AWS Spot Instances</title>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
          
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">Keyhan Vakil's blog</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
            </nav>
        </header>

        <main role="main">
            <article>
    <section>
        <h2>Remote builds with AWS Spot Instances</h2>
        <p><i>Tags:</i> <a title="All pages tagged 'selfhosted'." href="../tags/selfhosted.html" rel="tag">selfhosted</a></p>
        <p>Occasionally I contribute to open-source projects. Some of these
projects are really big and compiling them takes a long time. This is
usually not a problem in industry: either you’ll get an expensive
desktop machine or remote build access to a fleet of expensive “build
bot” machines.</p>
<p>Unfortunately I don’t have either of those – my laptop is nine years
old and was nowhere near state-of-the-art when I bought it. Compiling a
large open-source project like Node.js from scratch takes <em>hours</em>.</p>
<p>Anyway I used to get around this by having a beefy 32-core Amazon EC2
instance in the cloud. I would turn it on only when I was using it, and
there is a crontab configured to automatically shut-off the instance
every night in case I forget. There is a monthly charge for the <a href="https://aws.amazon.com/ebs/pricing/">disk
storage</a>, but it’s comparatively cheap. But even with careful stopping
and starting of the instance, it ends up being more expensive than I
would like. I spend a lot of time reading and writing code, and not
compiling it. But regardless of whether the CPUs are completely idle or
spinning at 100%, I’m paying Amazon multiple dollars per hour.</p>
<p>In addition to their on-demand instances, AWS provides “spot instances”,
which can be up to 90% cheaper. In exchange, you have to deal with
“interruptions”, where AWS can decide to terminate your instance in
order to get extra capacity.</p>
<p>I decided to create a “remote runner” tool. The idea is that I would run
<code>remote_run make test</code>, and it would:</p>
<ul>
<li>Start up a spot instance.</li>
<li>Send it the <code>make test</code> command and show me the results locally.</li>
<li>Have the spot machine linger around for a while (in case I have a
quick follow-up command) before shutting down.</li>
</ul>
<h2 id="boring-nitty-gritty-details">Boring nitty gritty details</h2>
<p>This ended up being much trickier than I imagined, mostly because I had
a simplistic model of how AWS worked. Here’s what I ended up building in
practice:</p>
<figure>
<img src="../assets/build-bot-ugly.png" alt="Build bot “architecture” diagram" />
<figcaption aria-hidden="true">Build bot “architecture” diagram</figcaption>
</figure>
<p>First, there are various build dependencies which need to be on the
root disk in order to actually do the build. We could install them
whenever we run a command but that would add significantly to the
start time. Instead we build an “AMI”, which is Amazon speak for a
virtual machine image. I used <a href="https://developer.hashicorp.com/packer">Hashicorp’s Packer</a> to do this.
This is a “one-time” setup, although you’ll have to do it
“one-more-time” whenever you add new build dependencies.</p>
<p>Next, we need to store the build artifacts and repositories
somewhere. This was easy for on-demand instances, because there was a
single instance and it could just have an EBS volume attached. For
spot instances this ended up being tricky: you need to manually
attach the EBS volume and mount it on the machine when it starts.</p>
<p>At this point I was able to start actually running build commands. I
added a <code>git push</code> over SSH to sync up my local code to the remote,
and got my first build passing :)</p>
<p>The runtime for doing a small command like <code>remote_run echo 1</code> was
unacceptably slow even when the spot instance was already warm: 2-3
seconds. One of those seconds was because the spot instance IP
required AWS API calls which were not fast. I built a “local cache”
which stored the last known IP. Establishing new SSH connections for
each command took an additional second, I used <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Multiplexing">OpenSSH’s
multiplexing</a> feature which brought it down to ~60ms.</p>
<p>Then there were a bunch of annoying edge cases, like handling running
a command when a spot instance was shutting down or starting up, or
trying to make the remote runner robust even when I pressed Ctrl-C
halfway through the pipeline.</p>
<p>Annoyingly, while testing my code I started getting random errors. AWS
informed me that they suspected that my account had been compromised. I
suspect the average cryptomining workload looks pretty similar to this,
although theirs is perhaps more economically productive.</p>
<h2 id="conclusion">Conclusion</h2>
<p>The end result of all this toil:</p>
<ol type="1">
<li>I can do builds really fast! My most complicated projects can do a
full compile in ~minutes.</li>
<li>“Cold” commands take around 20-30 seconds for the spot EC2 instance
to become ready, and then degraded performance while the EBS volume
warms up.</li>
<li>“Warm” commands take an additional ~100ms which is very reasonable.</li>
</ol>
<p>Against my better judgement, here is the full code. It’s a series of
unprincipled hacks (and using StrictHostKeyChecking=no is dangerous),
but it works well for my workflow.</p>
<details>
<summary>
Python Code
</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> botocore.exceptions <span class="im">import</span> ClientError</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shlex <span class="im">import</span> quote</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> wraps</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> time, sleep</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>base_ssh_command <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>ec2 <span class="op">=</span> boto3.client(<span class="st">&quot;ec2&quot;</span>, region_name<span class="op">=</span><span class="st">&quot;us-west-2&quot;</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>fp <span class="op">=</span> <span class="st">&quot;/b/v8/v8&quot;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>volume_id <span class="op">=</span> <span class="st">&quot;vol-xxxxxxxxxxxxxxxxx&quot;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>verbose <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Color:</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    GREEN <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\033</span><span class="st">[1;32;48m&quot;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    RED <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\033</span><span class="st">[1;31;48m&quot;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    BLUE <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\033</span><span class="st">[1;34;48m&quot;</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    END <span class="op">=</span> <span class="st">&quot;</span><span class="ch">\033</span><span class="st">[1;37;0m&quot;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> verbose_timing(f):</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">@wraps</span>(f)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> wrap(<span class="op">*</span>args, <span class="op">**</span>kw):</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> time()</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>Color<span class="sc">.</span>BLUE<span class="sc">}</span><span class="ss">running </span><span class="sc">{</span>f<span class="sc">.</span><span class="va">__name__</span><span class="sc">}{</span>Color<span class="sc">.</span>END<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> f(<span class="op">*</span>args, <span class="op">**</span>kw)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>            error <span class="op">=</span> e</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        te <span class="op">=</span> time()</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        diff <span class="op">=</span> te <span class="op">-</span> ts</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> diff <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>            diff_nice <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>diff<span class="sc">:2.4f}</span><span class="ss"> sec&quot;</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>            diff_nice <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span><span class="bu">int</span>(diff<span class="op">*</span><span class="dv">1000</span>)<span class="sc">}</span><span class="ss"> ms&quot;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> error:</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>Color<span class="sc">.</span>RED<span class="sc">}</span><span class="ss">... failed in </span><span class="sc">{</span>diff_nice<span class="sc">}{</span>Color<span class="sc">.</span>END<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> error</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>Color<span class="sc">.</span>GREEN<span class="sc">}</span><span class="ss">... done in </span><span class="sc">{</span>diff_nice<span class="sc">}{</span>Color<span class="sc">.</span>END<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> wrap</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>timing <span class="op">=</span> verbose_timing <span class="cf">if</span> verbose <span class="cf">else</span> <span class="kw">lambda</span> f: f</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_instance_information(instance_name):</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    instances <span class="op">=</span> ec2.describe_instances(</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        Filters<span class="op">=</span>[</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>            {<span class="st">&quot;Name&quot;</span>: <span class="st">&quot;instance-state-name&quot;</span>, <span class="st">&quot;Values&quot;</span>: [<span class="st">&quot;pending&quot;</span>, <span class="st">&quot;running&quot;</span>]},</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>            {<span class="st">&quot;Name&quot;</span>: <span class="st">&quot;tag:Name&quot;</span>, <span class="st">&quot;Values&quot;</span>: [instance_name]},</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> reservation <span class="kw">in</span> instances[<span class="st">&quot;Reservations&quot;</span>]:</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> instance <span class="kw">in</span> reservation[<span class="st">&quot;Instances&quot;</span>]:</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;public_ip&quot;</span>: instance[<span class="st">&quot;NetworkInterfaces&quot;</span>][<span class="dv">0</span>][<span class="st">&quot;Association&quot;</span>][</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;PublicIp&quot;</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>                ],</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;instance_id&quot;</span>: instance[<span class="st">&quot;InstanceId&quot;</span>],</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;has_volume&quot;</span>: <span class="bu">any</span>(</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>                    (</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>                        bdm[<span class="st">&quot;Ebs&quot;</span>][<span class="st">&quot;VolumeId&quot;</span>] <span class="op">==</span> volume_id</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> bdm <span class="kw">in</span> instance[<span class="st">&quot;BlockDeviceMappings&quot;</span>]</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>                ),</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;state&quot;</span>: instance[<span class="st">&quot;State&quot;</span>][<span class="st">&quot;Name&quot;</span>],</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> request_spot_instance(instance_name, instance_type):</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    request <span class="op">=</span> {</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;MaxCount&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;MinCount&quot;</span>: <span class="dv">1</span>,</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ImageId&quot;</span>: <span class="st">&quot;ami-xxxxxxxxxxxxxxxxx&quot;</span>,</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;InstanceType&quot;</span>: instance_type,</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;InstanceInitiatedShutdownBehavior&quot;</span>: <span class="st">&quot;terminate&quot;</span>,</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;KeyName&quot;</span>: instance_name,</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;EbsOptimized&quot;</span>: <span class="va">True</span>,</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;UserData&quot;</span>: base64.b64encode(</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>            <span class="st">b'#!/bin/bash</span><span class="ch">\n</span><span class="st">echo &quot;shutdown -h now&quot; | at now + 5 min</span><span class="ch">\n</span><span class="st">'</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        ).decode(<span class="st">&quot;utf8&quot;</span>),</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;NetworkInterfaces&quot;</span>: [</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;SubnetId&quot;</span>: <span class="st">&quot;subnet-xxxxxxxxxxxxxxxxx&quot;</span>,</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;AssociatePublicIpAddress&quot;</span>: <span class="va">True</span>,</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;DeviceIndex&quot;</span>: <span class="dv">0</span>,</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Groups&quot;</span>: [<span class="st">&quot;sg-xxxxxxxxxxxxxxxxx&quot;</span>],</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;TagSpecifications&quot;</span>: [</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;ResourceType&quot;</span>: <span class="st">&quot;instance&quot;</span>,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Tags&quot;</span>: [{<span class="st">&quot;Key&quot;</span>: <span class="st">&quot;Name&quot;</span>, <span class="st">&quot;Value&quot;</span>: <span class="st">&quot;build-bot&quot;</span>}],</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;InstanceMarketOptions&quot;</span>: {<span class="st">&quot;MarketType&quot;</span>: <span class="st">&quot;spot&quot;</span>},</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;MetadataOptions&quot;</span>: {</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;HttpTokens&quot;</span>: <span class="st">&quot;required&quot;</span>,</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;HttpEndpoint&quot;</span>: <span class="st">&quot;enabled&quot;</span>,</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;HttpPutResponseHopLimit&quot;</span>: <span class="dv">2</span>,</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;PrivateDnsNameOptions&quot;</span>: {</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;HostnameType&quot;</span>: <span class="st">&quot;ip-name&quot;</span>,</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;EnableResourceNameDnsARecord&quot;</span>: <span class="va">False</span>,</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;EnableResourceNameDnsAAAARecord&quot;</span>: <span class="va">False</span>,</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> ec2.run_instances(<span class="op">**</span>request)</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response[<span class="st">&quot;Instances&quot;</span>][<span class="dv">0</span>][<span class="st">&quot;SpotInstanceRequestId&quot;</span>]</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> wait_for_spot_instance_request(spot_request_id):</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> ec2.describe_spot_instance_requests(</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>            SpotInstanceRequestIds<span class="op">=</span>[spot_request_id]</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>        state <span class="op">=</span> response[<span class="st">&quot;SpotInstanceRequests&quot;</span>][<span class="dv">0</span>][<span class="st">&quot;State&quot;</span>]</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> state <span class="op">==</span> <span class="st">&quot;active&quot;</span>:</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>            instance_id <span class="op">=</span> response[<span class="st">&quot;SpotInstanceRequests&quot;</span>][<span class="dv">0</span>][<span class="st">&quot;InstanceId&quot;</span>]</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> instance_id</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> state <span class="op">==</span> <span class="st">&quot;failed&quot;</span>:</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;Spot instance request failed.&quot;</span>)</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="dv">1</span>)</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> attach_volume(instance_id):</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>    last_error <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> retries <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">60</span>):</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> ec2.attach_volume(</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>                Device<span class="op">=</span><span class="st">&quot;/dev/sdf&quot;</span>, InstanceId<span class="op">=</span>instance_id, VolumeId<span class="op">=</span>volume_id</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> ClientError <span class="im">as</span> e:</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>            str_e <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">&quot;(VolumeInUse)&quot;</span> <span class="kw">in</span> str_e <span class="kw">or</span> <span class="st">&quot;is not 'running'.&quot;</span> <span class="kw">in</span> str_e:</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> e</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> e</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>            sleep(<span class="dv">1</span>)</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> last_error</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mount_when_ready(public_ip, key_file_path):</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>    ssh_command <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>base_ssh_command<span class="sc">}</span><span class="ss"> ubuntu@</span><span class="sc">{</span>public_ip<span class="sc">}</span><span class="ss"> 'mountpoint /b &gt;/dev/null || </span><span class="ch">{{</span><span class="ss"> sudo mount /dev/nvme1n1 /b || sudo mount /dev/sdf /b || sudo mount /dev/xvdf /b; </span><span class="ch">}}</span><span class="ss">'&quot;</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> subprocess.call(ssh_command, shell<span class="op">=</span><span class="va">True</span>) <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="fl">0.1</span>)</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sync_changes_to_git():</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    subprocess.check_call(</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>        <span class="st">'git add -u &amp;&amp; git commit --allow-empty -m&quot;for build&quot;'</span>, shell<span class="op">=</span><span class="va">True</span></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> subprocess.check_output([<span class="st">&quot;git&quot;</span>, <span class="st">&quot;rev-parse&quot;</span>, <span class="st">&quot;HEAD&quot;</span>]).strip().decode(<span class="st">&quot;utf-8&quot;</span>)</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> push_git_sha(public_ip, key_file_path, git_sha):</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>    ssh_command <span class="op">=</span> (</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;git push -f ssh://ubuntu@</span><span class="sc">{</span>public_ip<span class="sc">}{</span>fp<span class="sc">}</span><span class="ss"> HEAD:refs/heads/for-spot-build&quot;</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>    subprocess.check_call(ssh_command, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup_build(public_ip, key_file_path, git_sha):</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    ssh_command <span class="op">=</span> (</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f&quot;</span><span class="sc">{</span>base_ssh_command<span class="sc">}</span><span class="ss"> ubuntu@</span><span class="sc">{</span>public_ip<span class="sc">}</span><span class="ss"> 'cd </span><span class="sc">{</span>fp<span class="sc">}</span><span class="ss"> &amp;&amp; git checkout -q </span><span class="sc">{</span>git_sha<span class="sc">}</span><span class="ss">'&quot;</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>    subprocess.check_call(ssh_command, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_command(public_ip, key_file_path, user_command):</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    ssh_command <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>base_ssh_command<span class="sc">}</span><span class="ss"> ubuntu@</span><span class="sc">{</span>public_ip<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>quote(user_command)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>        subprocess.call(ssh_command, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rsync_from_remote(public_ip, key_file_path, remote_path, local_path):</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    rsync_command <span class="op">=</span> <span class="ss">f&quot;rsync --info=progress2 -a -r -e '</span><span class="sc">{</span>base_ssh_command<span class="sc">}</span><span class="ss">' ubuntu@</span><span class="sc">{</span>public_ip<span class="sc">}</span><span class="ss">:</span><span class="sc">{</span>remote_path<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>local_path<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    subprocess.check_call(rsync_command, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_build_bot_from_cache(cache_directory):</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.load(<span class="bu">open</span>(cache_directory <span class="op">+</span> <span class="st">&quot;/build_bot.json&quot;</span>, <span class="st">&quot;r&quot;</span>))</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> store_build_bot_cache(cache_directory, build_bot):</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>        os.makedirs(cache_directory)</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> errno <span class="im">import</span> EEXIST</span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> e.errno <span class="op">!=</span> EEXIST:</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> json.dump(build_bot, <span class="bu">open</span>(cache_directory <span class="op">+</span> <span class="st">&quot;/build_bot.json&quot;</span>, <span class="st">&quot;w&quot;</span>))</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_build_bot_alive(public_ip):</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>    shutdown_command <span class="op">=</span> reschedule_shutdown_command(<span class="dv">10</span>)</span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>    ssh_command <span class="op">=</span> <span class="ss">f&quot;</span><span class="sc">{</span>base_ssh_command<span class="sc">}</span><span class="ss"> -o ConnectTimeout=3 ubuntu@</span><span class="sc">{</span>public_ip<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>quote(shutdown_command)<span class="sc">}</span><span class="ss"> &gt;/dev/null 2&gt;/dev/null&quot;</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>        subprocess.check_call(ssh_command, shell<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> subprocess.CalledProcessError:</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a><span class="at">@timing</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> invalidate_build_bot_cache(cache_directory):</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> shutil <span class="im">import</span> rmtree</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&quot;/build-bot/&quot;</span> <span class="kw">not</span> <span class="kw">in</span> cache_directory:</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;failing because cache directory looks wrong&quot;</span>)</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>    rmtree(cache_directory)</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reschedule_shutdown_command(minutes):</span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Only cancel existing shutdown jobs after we've scheduled a new</span></span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    <span class="co"># shutdown, so that there's always a shutdown scheduled even in the</span></span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>    <span class="co"># face of incoming interrupts.</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f'sudo bash -c &quot;to_cancel=$(atq | cut -f 1); echo shutdown -h | at now + </span><span class="sc">{</span>minutes<span class="sc">}</span><span class="ss"> min; echo &quot;$to_cancel&quot; | xargs atrm; exit 0&quot; &gt;/dev/null 2&gt;/dev/null'</span></span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>    build_bot <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>    key_file_path <span class="op">=</span> <span class="st">&quot;~/.ssh/build-bot.pem&quot;</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>    base_ssh_command <span class="op">=</span> <span class="ss">f&quot;ssh -i </span><span class="sc">{</span>key_file_path<span class="sc">}</span><span class="ss"> -o StrictHostKeyChecking=no -o ControlMaster=auto -o ControlPath=/tmp/%C -o ControlPersist=10m&quot;</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>    instance_name <span class="op">=</span> <span class="st">&quot;build-bot&quot;</span></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>    instance_type <span class="op">=</span> <span class="st">&quot;c7a.8xlarge&quot;</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>    cache_directory <span class="op">=</span> os.path.expanduser(<span class="st">&quot;~/.cache/build-bot/&quot;</span>)</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.isdir(cache_directory):</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>        build_bot <span class="op">=</span> load_build_bot_from_cache(cache_directory)</span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> retries <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">60</span>):</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> is_build_bot_alive(build_bot[<span class="st">&quot;public_ip&quot;</span>]):</span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>            sleep(<span class="dv">1</span>)</span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> get_instance_information(instance_name) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>                <span class="co"># The build bot went away (as expected).</span></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>                invalidate_build_bot_cache(cache_directory)</span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>                build_bot <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;build bot is present but not responsive&quot;</span>)</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>    user_command <span class="op">=</span> <span class="st">&quot; &quot;</span>.join(sys.argv[<span class="dv">1</span>:])</span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>    local_out_directory <span class="op">=</span> <span class="st">&quot;~/v8/v8/out/x64.release&quot;</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    commands_to_run <span class="op">=</span> [<span class="ss">f&quot;cd </span><span class="sc">{</span>fp<span class="sc">}</span><span class="ss">&quot;</span>, <span class="st">&quot;export PATH=/b/depot_tools:$PATH&quot;</span>]</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>    os.environ[<span class="st">&quot;GIT_SSH_COMMAND&quot;</span>] <span class="op">=</span> base_ssh_command</span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> build_bot <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>        build_bot <span class="op">=</span> get_instance_information(instance_name)</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> build_bot <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>        spot_request_id <span class="op">=</span> request_spot_instance(instance_name, instance_type)</span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>        instance_id <span class="op">=</span> wait_for_spot_instance_request(spot_request_id)</span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> retries <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">60</span>):</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>                sleep(<span class="dv">1</span>)</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>                build_bot <span class="op">=</span> get_instance_information(instance_name)</span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> build_bot <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">KeyError</span>:  <span class="co"># network not ready yet...</span></span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;spot instance request fulfilled but no bot&quot;</span>)</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>    public_ip <span class="op">=</span> build_bot[<span class="st">&quot;public_ip&quot;</span>]</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> build_bot[<span class="st">&quot;has_volume&quot;</span>]:</span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>        instance_id <span class="op">=</span> build_bot[<span class="st">&quot;instance_id&quot;</span>]</span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>        attach_volume(instance_id)</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>        build_bot[<span class="st">&quot;has_volume&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> build_bot.get(<span class="st">&quot;has_mount&quot;</span>):</span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>        mount_when_ready(public_ip, key_file_path)</span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>        build_bot[<span class="st">&quot;has_mount&quot;</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&quot;gm.py&quot;</span> <span class="kw">in</span> user_command:</span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>        git_sha <span class="op">=</span> sync_changes_to_git()</span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>        push_git_sha(public_ip, key_file_path, git_sha)</span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>        commands_to_run.append(<span class="ss">f&quot;git checkout </span><span class="sc">{</span>git_sha<span class="sc">}</span><span class="ss"> &gt;/dev/null&quot;</span>)</span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>    commands_to_run.append(user_command)</span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>    commands_to_run.append(reschedule_shutdown_command(<span class="dv">3</span>))</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>    run_command(public_ip, key_file_path, <span class="st">&quot;;&quot;</span>.join(commands_to_run))</span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>    store_build_bot_cache(cache_directory, build_bot)</span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add as necessary</span></span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rsync_from_remote(public_ip, key_file_path, f&quot;{fp}/out/x64.release/&quot;, local_out_directory)</span></span></code></pre></div>
</details>
<details>
<summary>
Packer Code
</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">packer</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">required_plugins</span> {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">amazon</span> = {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>      <span class="ex">version</span> = <span class="st">&quot;&gt;= 0.0.1&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>      <span class="bu">source</span>  = <span class="st">&quot;github.com/hashicorp/amazon&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> <span class="st">&quot;amazon-ebs&quot;</span> <span class="st">&quot;ubuntu&quot;</span> {</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ami_name</span>      = <span class="st">&quot;build-bot-ami&quot;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">instance_type</span> = <span class="st">&quot;c7a.xlarge&quot;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="ex">region</span>        = <span class="st">&quot;us-west-2&quot;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">source_ami_filter</span> {</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">filters</span> = {</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      <span class="ex">name</span>                = <span class="st">&quot;ubuntu/images/*ubuntu-focal-20.04-amd64-server-*&quot;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">root-device-type</span>    = <span class="st">&quot;ebs&quot;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      <span class="ex">virtualization-type</span> = <span class="st">&quot;hvm&quot;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="ex">most_recent</span> = true</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="ex">owners</span>      = <span class="pp">[</span><span class="st">&quot;099720109477&quot;</span><span class="pp">]</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ssh_username</span> = <span class="st">&quot;ubuntu&quot;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="ex">build</span> {</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="ex">name</span>    = <span class="st">&quot;build-bot&quot;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="ex">sources</span> = [</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;source.amazon-ebs.ubuntu&quot;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="ex">provisioner</span> <span class="st">&quot;file&quot;</span> {</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">source</span> = <span class="st">&quot;../build-bot.pub&quot;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="ex">destination</span> = <span class="st">&quot;/tmp/build-bot.pub&quot;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">provisioner</span> <span class="st">&quot;shell&quot;</span> {</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="ex">script</span> = <span class="st">&quot;setup.sh&quot;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
</details>
<details>
<summary>
<code>setup.sh</code> Shell Code (used by Packer)
</summary>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-Eeuox</span> pipefail</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Update &amp; upgrade all packages.</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">DEBIAN_FRONTEND</span><span class="op">=</span>noninteractive</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update <span class="at">-y</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get <span class="at">-y</span> <span class="at">-o</span> Dpkg::Options::=<span class="st">&quot;--force-confdef&quot;</span> <span class="dt">\</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">-o</span> Dpkg::Options::=<span class="st">&quot;--force-confold&quot;</span> dist-upgrade</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the SSH key.</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/.ssh</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 700 ~/.ssh</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /tmp/build-bot.pub ~/.ssh/authorized_keys</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 600 ~/.ssh/authorized_keys</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Some dependencies I use.</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get <span class="at">-y</span> <span class="at">-qq</span> install ninja-build ccache</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Dependencies for V8/Chromium.</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://chromium.googlesource.com/chromium/src/+/main/build/install-build-deps.py<span class="pp">?</span>format=TEXT <span class="dt">\</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span> <span class="op">&gt;</span> /tmp/install_build_deps.py</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> python3 /tmp/install_build_deps.py</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co"># By default you can't log in while the machine is booting or</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># shutting down. Comment that out - lets us SSH in faster.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> sed <span class="at">-i</span> <span class="st">'/account[[:space:]]*required[[:space:]]*pam_nologin.so/s/^/#/'</span> /etc/pam.d/sshd</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the mountpoint.</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir <span class="at">-p</span> /b</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> chown ubuntu:ubuntu /b</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Add some configuration files outside of the root mount.</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/.ccache</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> ~/.ccache/ccache.conf <span class="op">&lt;&lt;EOF</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="st">max_size = 32.0G</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="st">cache_dir = /b/ccache</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> . /b/.bashrc <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> source /b/.vimrc <span class="op">&gt;&gt;</span> ~/.vimrc</span></code></pre></div>
</details>
<p>P.S. After doing all this, I’m thinking I’ll just buy a new computer.</p>
    </section>
    <section class="header">
        
        Posted on 2023-11-26
    </section>
</article>

        </main>

        <footer>
            <a href="https://github.com/kvakil">Github</a> | Email: ken [at sign] kvakil.me
        </footer>

        <script type="text/javascript" src="../js/load-annotator.js"></script>
    </body>
</html>
